(function(d,f,g,b){if(d===null){throw Error("Please load jquery firstly!")}var i=function(k,j){var l;return function(){if(!l){l=setTimeout(function(){k();clearTimeout(l);l=null},j)}}};var a=(function(){var k=g.createElement("div"),l=g.documentElement;if(!("pointerEvents" in k.style)){return false}k.style.pointerEvents="auto";k.style.pointerEvents="x";l.appendChild(k);var j=f.getComputedStyle&&f.getComputedStyle(k,"").pointerEvents==="auto";l.removeChild(k);return !!j})();var c={listNodeName:"ul",itemNodeName:"li",rootClass:"drop drop-list drop-list-normal",handleClass:"drop-handle",placeholderClass:"drop-placeholder",depthClass:"list-depth-",noDragClass:"drop-nodrag",dragClass:"drop-dragWrapper",maxDepth:5,thresholdX:30,thresholdY:30,itemFactory:null,};function h(k,j){this.doc=d(g);this.el=d(k);var l=j.data;delete j.data;this.options=d.extend({},c,j);this.init(l)}h.prototype.serialize=function(){var l=this.el.find(this.options.itemNodeName).first(),o=[],p=this.dataSet,n,q,j,k=0,m,t=0,j,r=[],s;while(l.length){j=+l.attr("data-term-id");m=+l.attr("data-depth");if(r.length===0){this.dataSet[j].parent=0;r.push({depth:m,id:j});k=m;t=j}else{if(m>k){this.dataSet[j].parent=t;r.push({depth:m,id:j});k=m;t=j}else{if(m===k){s=r.pop();this.dataSet[j].parent=s.id;s.id=j;t=j;r.push(s)}else{s=r.pop();while(s){if(s.depth>m){s=r.pop();continue}else{if(s.depth===m){this.dataSet[j].parent=this.dataSet[s.id].parent;t=j;k=m;r.push({depth:m,id:j});break}}s=r.pop()}}}}l=l.next()}return this.dataSet},h.prototype.init=function(m){function p(w,z){if(z){var y=d(g.createElement(this.options.itemNodeName)).addClass(this.options.depthClass+z.depth);y.attr("data-depth",z.depth);y.attr("data-term-id",z.term_id);y.append(this.options.itemFactory(z));y.appendTo(w);if(z.children.length>0){for(var x=0,v=z.children.length;x<v;x++){w=p.call(this,w,z.children[x])}}}return w}function k(A){var w={},y,v=A.length-1,x=[],z;for(y=v;y>=0;y--){A[y].children=[];w[A[y].term_id]=A[y]}for(y=v;y>=0;y--){z=A[y].parent;if(z===0){x.push(A[y])}else{w[z].children.push(A[y])}}return x}var q=function(w){var v=d(w.target);if(!v.hasClass(s.options.handleClass)){if(v.closest("."+s.options.noDragClass).length){return}v=v.closest("."+s.options.handleClass)}if(!v.length||t.dragEl){return}w.preventDefault();s.dragStart(w)};var j=function(v){if(s.dragEl){v.preventDefault();s.dragStop(v)}};var l=function(v){if(s.dragEl){v.preventDefault();s.dragMove(v)}};var u,n,s=this,o;try{this.dataSet={};for(n=0,o=m.length;n<o;n++){this.dataSet[m[n].term_id]=m[n]}u=new e(k(m))}catch(r){throw r}var t=d(g.createElement(this.options.listNodeName)).addClass(this.options.rootClass);for(n=0,o=u.children.length;n<o;n++){t=p.call(this,t,u.children[n])}t.appendTo(this.el);this.placeholder=d('<li class="'+this.options.placeholderClass+'"/>');this.reset();this.el.on("mousedown",q);this.doc.on("mousemove",l);this.doc.on("mouseup",j)};h.prototype.dragStart=function(o){var l=this.mouse,n=d(o.target),n=n.closest(this.options.itemNodeName),k=null,p=parseInt(n.attr("data-depth")),j=n.parent(),m=n.prev()||j;l.nowX=o.pageX;l.nowY=o.pageY;l.offsetX=o.offsetX!==b?o.offsetX:o.pageX-n.offset().left;l.offsetY=o.offsetY!==b?o.offsetY:o.pageY-n.offset().top;this.dragEl=d(g.createElement(this.options.listNodeName)).addClass(this.options.rootClass+" "+this.options.dragClass);while((k=n.next())&&parseInt(k.attr("data-depth"))>p){this.dragEl.append(k)}this.dragEl.prepend(n);this.dragEl.css({left:o.pageX-l.offsetX,top:o.pageY-l.offsetY});this.dragEl.width(j.width());d(g.body).append(this.dragEl);this.placeholder.height(this.dragEl.height());this.placeholder.addClass("list-depth-"+p);if(m.length){this.placeholder.insertAfter(m)}else{j.prepend(this.placeholder)}};h.prototype.dragStop=function(n){var l=this.dragEl.children(),k=this.options,o=((new RegExp(k.depthClass+"(\\d*)")).exec(this.placeholder.attr("class")))[1],p=o-(+(d(l[0]).attr("data-depth"))),m,j;for(j=l.length-1;j>=0;j--){m=d(l[j]);o=+m.attr("data-depth")+p;m.attr("class",k.depthClass+o);m.attr("data-depth",o);m.insertAfter(this.placeholder)}this.placeholder.remove();this.placeholder.attr("class",this.options.placeholderClass);this.dragEl.remove();this.reset()};h.prototype.dragMove=function(o){var j=this.mouse,m,n,l,p,k=this.options;this.dragEl.css({left:o.pageX-j.offsetX,top:o.pageY-j.offsetY});j.lastX=j.nowX;j.lastY=j.nowY;j.nowX=o.pageX;j.nowY=o.pageY;j.distX=j.nowX-j.lastX;j.distY=j.nowY-j.lastY;j.distAtX+=j.distX;j.distAtY+=j.distY;if(j.distAtX>k.thresholdX){p=((new RegExp(k.depthClass+"(\\d*)")).exec(this.placeholder.attr("class")))[1];p=+p;n=this.placeholder.prev(k.itemNodeName);if(+n.attr("data-depth")!==(p-1)){while(n.length){if(+n.attr("data-depth")>=p){break}else{n=n.prev(k.itemNodeName)}}if(n.length){this.placeholder.removeClass(k.depthClass+p);this.placeholder.addClass(k.depthClass+(p+1))}}j.distAtX=0}else{if(j.distAtX<-k.thresholdX){l=this.placeholder.next();p=((new RegExp(k.depthClass+"(\\d*)")).exec(this.placeholder.attr("class")))[1];p=+p;if((p-1)>=1&&(!l||+l.attr("data-depth")-1!==p)){this.placeholder.removeClass(k.depthClass+p);this.placeholder.addClass(k.depthClass+(p-1))}j.distAtX=0}}if(!a){this.dragEl[0].style.visibility="hidden"}this.pointEl=d(g.elementFromPoint(o.pageX-g.body.scrollLeft,o.pageY-(f.pageYOffset||g.documentElement.scrollTop)));if(!a){this.dragEl[0].style.visibility="visible"}if(j.distAtY<-k.thresholdY){n=this.pointEl.closest(k.itemNodeName);n=n.prev();if(n.length){p=((new RegExp(k.depthClass+"(\\d*)")).exec(this.placeholder.attr("class")))[1];p=+p;this.placeholder.removeClass(k.depthClass+p);this.placeholder.addClass(k.depthClass+(n.attr("data-depth")));this.placeholder.insertAfter(n)}else{p=((new RegExp(k.depthClass+"(\\d*)")).exec(this.placeholder.attr("class")))[1];p=+p;this.placeholder.removeClass(k.depthClass+p);this.placeholder.addClass(k.depthClass+1);this.el.find("ul").prepend(this.placeholder)}j.distAtY=0}else{if(j.distAtY>k.thresholdY){n=this.pointEl.closest(k.itemNodeName);if(n.lenght){this.placeholder.insertAfter(n)}else{this.placeholder.appendTo(this.placeholder.parent())}j.distAtY=0}}};h.prototype.reset=function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,distAtX:0,distAtY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null};var e=function(m,n){this.children=[];this.depth=n||0;var l=0,j;if(m.children===b){for(l=0,j=m.length;l<j;l++){this.children.push(new e(m[l],this.depth+1))}}else{var k=m.children;delete m.children;for(l in m){this[l]=m[l]}for(l=0,j=k.length;l<j;l++){this.children.push(new e(k[l],n+1))}}};d.fn.dropList=function(m){var l=this,j;var k=d(this).data("plugin");if(!k){k=new h(this,m);d(this).data("plugin",k);this.plugin=k}else{if(typeof m==="string"&&k[m]==="function"){j=k[m]()}}return j||l}})($||null,window,document,undefined);
